<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ v3.9</title>
<style>
  :root{
    --bg:#0b1020;--panel:#11162d;--bubble:#141b2e;--bubble-user:#1e2a50;
    --border:#223066;--text:#e7ecff;--accent:#4b6bff;--muted:#9fb3ff;--card:#0f1530;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,Segoe UI,Arial}
  header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;z-index:10}
  header .bar{max-width:1000px;margin:auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px;color:var(--muted)} h1 small{opacity:.8;font-weight:400}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1733;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .pane{display:none} .pane.active{display:block}
  /* Chat */
  .chat{display:flex;flex-direction:column;gap:10px;margin-bottom:100px}
  .msg{max-width:85%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--bubble);white-space:pre-wrap;line-height:1.8}
  .user{align-self:flex-start;background:var(--bubble-user)}
  .bot{align-self:flex-end}
  .footer{position:fixed;inset-inline:0;bottom:0;background:var(--panel);border-top:1px solid var(--border)}
  .send{max-width:1000px;margin:10px auto;display:flex;gap:8px;padding:0 16px}
  input[type=text]{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1a38;color:white}
  button{padding:12px 16px;border:none;border-radius:12px;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  a{color:#8fb1ff;word-break:break-all}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0}
  .mono{font-family:ui-monospace,Consolas,monospace;font-size:13px}
  .uploader{border:1px dashed var(--border);border-radius:12px;padding:14px;background:#0f1733}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{opacity:.75}
  .grid{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .btn-sm{padding:6px 10px;border-radius:10px;background:#17306f;border:1px solid #2a3b76;color:#fff;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center}
  select, .chk {padding:8px 10px;border-radius:8px;background:#0f1a38;border:1px solid #223066;color:#fff}
  label.chk{display:inline-flex;gap:6px;align-items:center;border:none}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>ğŸ¤– Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ <small>v3.9</small></h1>
    <div class="controls">
      <label class="chk"><input id="pref-ar" type="checkbox" /> ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
      <label>Ø§Ù„ØªØ±Ø¬Ù…Ø©:
        <select id="trl" class="chk">
          <option value="ar" selected>Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
        </select>
      </label>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-pane="chat">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
    <div class="tab" data-pane="advanced">Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù‘Ù…</div>
    <div class="tab" data-pane="pdf">Ø±ÙØ¹ PDF</div>
    <div class="tab" data-pane="image">Ø¨Ø­Ø« Ø¹ÙƒØ³ÙŠ Ø¨ØµÙˆØ±Ø©</div>
    <div class="tab" onclick="window.open('/files_list','_blank')">ğŸ“‚ Ù…Ù„ÙØ§ØªÙŠ</div>
    <div class="tab" onclick="window.open('/healthz','_blank')">Ø§Ù„ØµØ­Ø©</div>
  </div>

  <!-- CHAT -->
  <section id="pane-chat" class="pane active">
    <div id="chat" class="chat">
      <div class="msg bot">
        Ø£Ù‡Ù„Ù‹Ø§! Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø¨Ø¯Ø£ Ø¨Ù…Ù„ÙØ§ØªÙƒ (RAG) Ø«Ù… Ø§Ù„ÙˆÙŠØ¨ Ø«Ù… Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª.
        <div class="muted">Ø£Ù…Ø«Ù„Ø©: â€œÙ…Ø§ Ù‡ÙŠ Ø§Ù„Ø®Ø±Ø³Ø§Ù†Ø© Ø§Ù„Ù…Ø³Ù„Ø­Ø©ØŸâ€ â€¢ â€œØªÙØ§Ø¶Ù„ x^3â€ â€¢ â€œØ§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨ Ø¹Ù† Ø¹Ø§ØµÙ…Ø© Ø£Ù„Ù…Ø§Ù†ÙŠØ§â€</div>
      </div>
    </div>
    <div class="footer">
      <div class="send">
        <input id="q" type="text" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ Enter" onkeydown="if(event.key==='Enter'){send()}" />
        <button id="btn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </section>

  <!-- ADVANCED SEARCH -->
  <section id="pane-advanced" class="pane">
    <div class="uploader">
      <div class="row">
        <input id="adv-q" type="text" placeholder="Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ø¨Ø­Ø«â€¦" style="flex:1;padding:12px;border-radius:10px;border:1px solid #223066;background:#0f1a38;color:#fff">
        <select id="adv-time" class="chk">
          <option value="">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
          <option value="d">Ø¢Ø®Ø± ÙŠÙˆÙ…</option>
          <option value="w">Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</option>
          <option value="m">Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
          <option value="y">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
        </select>
        <label class="chk"><input type="checkbox" id="adv-social"> Ø³ÙˆØ´Ø§Ù„</label>
        <label class="chk"><input type="checkbox" id="adv-market"> Ù…ØªØ§Ø¬Ø±</label>
        <label class="chk"><input type="checkbox" id="adv-gov"> Ø­ÙƒÙˆÙ…ÙŠ</label>
        <label class="chk"><input type="checkbox" id="adv-edu"> ØªØ¹Ù„ÙŠÙ…ÙŠ</label>
        <label class="chk"><input type="checkbox" id="adv-video"> ÙÙŠØ¯ÙŠÙˆ</label>
        <label class="chk"><input type="checkbox" id="adv-deep"> Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ‚</label>
      </div>
      <div class="row" style="margin-top:10px">
        <button onclick="runAdvanced()">Ø¨Ø­Ø«</button>
      </div>
      <div id="adv-out" class="card" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- PDF -->
  <section id="pane-pdf" class="pane">
    <div class="uploader">
      <div class="row">
        <input id="pdf" type="file" accept="application/pdf" />
        <button onclick="uploadPDF()">Ø±ÙØ¹ Ùˆ ÙÙ‡Ø±Ø³Ø©</button>
      </div>
      <div id="pdf-result" class="card mono"></div>
      <small class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ ÙŠÙØ³ØªØ®Ø±Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† PDF ÙˆÙŠÙØ¶Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ ÙÙ‡Ø±Ø³ RAG.</small>
    </div>
  </section>

  <!-- IMAGE -->
  <section id="pane-image" class="pane">
    <div class="uploader">
      <div class="row">
        <input id="img" type="file" accept="image/*" capture="environment" />
        <button onclick="uploadImage()">Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
      </div>
      <div id="img-result" class="card"></div>
      <small class="muted">Ø³Ø£Ø¹Ø·ÙŠÙƒ Ø±ÙˆØ§Ø¨Ø· Ø¨Ø­Ø« Ø¹ÙƒØ³ÙŠ Ø¬Ø§Ù‡Ø²Ø© (Google/Bing/Yandex/TinEye) Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªÙ†Ø²ÙŠÙ„Ù‡Ø§.</small>
    </div>
  </section>
</div>

<script>
/* ---------- Tabs ---------- */
document.querySelectorAll('.tab[data-pane]').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id=t.dataset.pane;
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    document.getElementById('pane-'+id).classList.add('active');
  });
});

/* ---------- Chat helpers ---------- */
const chat = document.getElementById('chat');
const qbox = document.getElementById('q');
const btn  = document.getElementById('btn');
const prefAR = document.getElementById('pref-ar');
const trlSel = document.getElementById('trl');

function escapeHTML(s){return (s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function mdLite(s){ return (s||'').replace(/\*\*(.+?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>'); }

// ÙƒØ´Ù Ø¹Ø±Ø¨ÙŠØ©: ÙˆØ¬ÙˆØ¯ Ø£Ø­Ø±Ù Ù†Ø·Ø§Ù‚ Ø¹Ø±Ø¨ÙŠ
const AR_RE=/[\u0600-\u06FF]/;
// Ù‚Ø§Ø¦Ù…Ø© Ù†Ø·Ø§Ù‚Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ø´Ø§Ø¦Ø¹Ø©
const AR_TLDS = ['.sa','.ae','.eg','.ma','.dz','.tn','.ly','.ye','.kw','.qa','.bh','.om','.jo','.iq','.ps','.lb','.sy','.sd','.mr','.so','.dev-point.com','.aljazeera.net','.alarabiya.net'];

function preferArabicFirst(arr){
  if(!prefAR.checked) return arr;
  const score = (s)=>{
    let sc = 0;
    const link = (s.link||'').toLowerCase();
    const txt  = (s.summary||s.snippet||'');
    if(AR_RE.test(txt)) sc += 3;
    for(const t of AR_TLDS){ if(link.includes(t)) sc += 2; }
    return sc;
  };
  return [...arr].sort((a,b)=>score(b)-score(a));
}

function add(text, who='bot', isHTML=false){
  const div=document.createElement('div');
  div.className='msg '+(who==='user'?'user':'bot');
  div[isHTML?'innerHTML':'textContent']=text;
  chat.appendChild(div);
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  return div;
}

function tLinkURL(url, target){
  // Ø±Ø§Ø¨Ø· ØªØ±Ø¬Ù…Ø© Google
  const tl = target || trlSel.value || 'ar';
  return `https://translate.google.com/translate?sl=auto&tl=${encodeURIComponent(tl)}&u=${encodeURIComponent(url)}`;
}

function tTextURL(text, target){
  // ØªØ±Ø¬Ù…Ø© Ù†Øµ Ø¹Ø¨Ø± Google Translate UI (Ù„Ù„Ù†Øµ ÙÙ‚Ø·)
  const tl = target || trlSel.value || 'ar';
  return `https://translate.google.com/?sl=auto&tl=${encodeURIComponent(tl)}&text=${encodeURIComponent(text)}`;
}

function showSources(results){
  if(!results||!results.length) return '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
  const sorted = preferArabicFirst(results);
  return sorted.map(s=>{
    const name = (s.link||'').split('/').pop() || 'file';
    const isPDF = /\.pdf(\?|$)/i.test(s.link||'');
    const trURL = s.link ? tLinkURL(s.link) : '#';
    const trSum = tTextURL(s.summary||s.snippet||'');
    return `
    <div class="card">
      <b>${escapeHTML(s.title||'')}</b><br>
      <a href="${s.link}" target="_blank">${s.link}</a>
      <div><small>${escapeHTML(s.summary||s.snippet||'')}</small></div>
      <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn-sm" target="_blank" href="${s.link}">ÙØªØ­</a>
        <button class="btn-sm" onclick="downloadFile('${s.link.replace(/'/g,'\\\'')}', '${isPDF ? (name||'document.pdf') : name}')">ØªÙ†Ø²ÙŠÙ„</button>
        <a class="btn-sm" target="_blank" href="${trURL}">ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµÙØ­Ø©</a>
        <a class="btn-sm" target="_blank" href="${trSum}">ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ù„Ø®Øµ</a>
      </div>
    </div>`;
  }).join('');
}

/* ---------- Ask ---------- */
async function send(){
  let q=(qbox.value||'').trim();
  if(!q) return;
  add(q,'user'); qbox.value=''; qbox.focus();
  const wait=add('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦','bot');

  // Ù„Ùˆ Ù…ÙØ¹Ù‘Ù„ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØŒ Ù†Ø²ÙˆØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ØªÙ„Ù…ÙŠØ­ Ø®ÙÙŠÙ (Ù„Ø§ ÙŠØ¶Ø±)
  if(prefAR.checked) q = q + ' (Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹)';

  btn.disabled=true;
  try{
    const res=await fetch('/ask?q='+encodeURIComponent(q));
    const j=await res.json();
    wait.remove();

    if(j.type==='math'){
      add('<b>ğŸ§® Ø±ÙŠØ§Ø¶ÙŠØ§Øª:</b><pre class="mono">'+escapeHTML(JSON.stringify(j.result,null,2))+'</pre>','bot',true);
    }else if(j.sources){
      add('<b>ğŸŒ Ø£ÙØ¶Ù„ Ù…Ø§ ÙˆØ¬Ø¯Øª:</b>'+showSources(j.sources),'bot',true);
    }else if(j.results){ // ØªÙˆØ§ÙÙ‚ Ù‚Ø¯ÙŠÙ…
      add('<b>ğŸŒ Ù†ØªØ§Ø¦Ø¬:</b>'+showSources(j.results),'bot',true);
    }else{
      const ans = j.answer||j.summary||j.msg||'Ù„Ù… Ø£ÙÙ‡Ù….';
      const html = mdLite(ans) + 
        ` <div style="margin-top:6px">
            <a class="btn-sm" target="_blank" href="${tTextURL(ans)}">ØªØ±Ø¬Ù…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯</a>
          </div>`;
      add(html,'bot',true);
    }
  }catch(e){
    wait.remove();
    add('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„.','bot');
  }finally{
    btn.disabled=false;
  }
}

/* ---------- Advanced search ---------- */
async function runAdvanced(){
  let q   = document.getElementById('adv-q').value.trim();
  const t   = document.getElementById('adv-time').value;
  const opt = {
    social: document.getElementById('adv-social').checked,
    market: document.getElementById('adv-market').checked,
    gov:    document.getElementById('adv-gov').checked,
    edu:    document.getElementById('adv-edu').checked,
    video:  document.getElementById('adv-video').checked,
    deep:   document.getElementById('adv-deep').checked
  };
  const out = document.getElementById('adv-out');
  if(!q){ out.textContent='Ø§ÙƒØªØ¨ Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ø¨Ø­Ø«.'; return; }
  out.textContent='â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦';

  if(prefAR.checked) q = q + ' (Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹)';

  const qs = new URLSearchParams({q, timelimit:t});
  Object.entries(opt).forEach(([k,v])=>{ if(v) qs.set(k,'true'); });

  try{
    const r = await fetch('/search/advanced?'+qs.toString());
    const j = await r.json();
    const arr = j.results || [];
    out.innerHTML = `<b>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (${j.count||arr.length})</b>` + showSources(arr);
  }catch(e){ out.textContent='ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«.'; }
}

/* ---------- Proxy download via backend ---------- */
async function downloadFile(url, suggestedName="file"){
  try{
    const r = await fetch('/download?url=' + encodeURIComponent(url));
    if(!r.ok) throw new Error('DL failed');
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = suggestedName;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  }catch(e){ alert('ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„'); }
}

/* ---------- Upload PDF ---------- */
async function uploadPDF(){
  const inp=document.getElementById('pdf');
  const box=document.getElementById('pdf-result');
  if(!inp.files.length){ box.textContent='Ø§Ø®ØªØ± Ù…Ù„Ù PDF Ø£ÙˆÙ„Ù‹Ø§.'; return; }
  const fd=new FormData(); fd.append('file', inp.files[0]);
  box.textContent='â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ÙÙ‡Ø±Ø³Ø©...';
  try{
    const res=await fetch('/upload/pdf',{method:'POST',body:fd});
    const j=await res.json();
    box.innerHTML='<b>ØªÙ… Ø§Ù„Ø±ÙØ¹ âœ”ï¸</b><br>Ø§Ù„Ø±Ø§Ø¨Ø·: <a target="_blank" href="'+j.file_url+'">'+j.file_url+
      '</a> <button class="btn-sm" onclick="downloadFile(\''+j.file_url+'\', \'document.pdf\')">ØªÙ†Ø²ÙŠÙ„</button>'+
      '<br>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³: '+j.indexed_docs;
  }catch(e){
    box.textContent='ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹.';
  }
}

/* ---------- Upload Image + reverse search ---------- */
async function uploadImage(){
  const inp=document.getElementById('img');
  const box=document.getElementById('img-result');
  if(!inp.files.length){ box.textContent='Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ù‹Ø§.'; return; }
  const fd=new FormData(); fd.append('file', inp.files[0]);
  box.textContent='â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
  try{
    const res=await fetch('/upload/image',{method:'POST',body:fd});
    const j=await res.json();
    box.innerHTML = `
      <div>ØªÙ… Ø§Ù„Ø±ÙØ¹ âœ”ï¸ â€” <a target="_blank" href="${j.image_url}">ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø©</a>
      <button class="btn-sm" onclick="downloadFile('${j.image_url}', 'image')">ØªÙ†Ø²ÙŠÙ„</button></div>
      <div class="card">
        <div><a target="_blank" href="${j.reverse.google}">Ø¨Ø­Ø« Google</a></div>
        <div><a target="_blank" href="${j.reverse.bing}">Ø¨Ø­Ø« Bing</a></div>
        <div><a target="_blank" href="${j.reverse.yandex}">Ø¨Ø­Ø« Yandex</a></div>
        <div><a target="_blank" href="${j.reverse.tineye}">Ø¨Ø­Ø« TinEye</a></div>
      </div>`;
  }catch(e){
    box.textContent='ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹.';
  }
}

/* ---------- Enter key on chat ---------- */
qbox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ send(); } });
</script>
</body>
</html>
