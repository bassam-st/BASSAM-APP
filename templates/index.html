<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>بسّام الذكي v3.5</title>
<style>
  :root{
    --bg:#0b1020; --panel:#141b2e; --muted:#9fb4ff; --text:#e7ecff; --brand:#4f6ef7; --border:#223066;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0}
  .wrap{max-width:1000px;margin:28px auto;padding:0 14px}
  h1{margin:0 0 12px;font-weight:700}
  .bar{display:flex;gap:8px;align-items:center;margin:10px 0 14px}
  .in{flex:1;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:#0f1a38;color:#fff}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#fff;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .chip{background:#0f1a38;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
  .row{display:flex;gap:16px;align-items:center}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0}
  .muted{color:var(--muted)}
  .badge{background:#0f1a38;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0f1429;border:1px solid var(--border);padding:12px;border-radius:12px}
  .flex{display:flex;gap:8px;align-items:center}
  .space{height:8px}
  a{color:#9dc1ff}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .linkCard{background:#0f1429;border:1px solid var(--border);border-radius:12px;padding:10px}
  .footer{opacity:.7;font-size:13px;margin:18px 0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>🤖 بسّام الذكي <span class="badge">v3.5</span></h1>
    <div class="muted">اكتب سؤالك بالعربي أو الإنجليزي. جرّب أمثلة سريعة بالأسفل.</div>

    <div class="bar">
      <input id="q" class="in" placeholder="مثال: صمّم كمرة 6م Mu=120 kN·m … أو: اكتب دالة Python تجمع قائمتين">
      <button id="send" class="btn" onclick="ask()">إرسال</button>
    </div>

    <div class="chips" id="examples">
      <span class="chip">ما هي طبقات OSI؟</span>
      <span class="chip">صمّم كمرة 6م Mu=120 kN·m</span>
      <span class="chip">ما عاصمة ألمانيا؟</span>
      <span class="chip">اشرح REST API ببساطة</span>
      <span class="chip">اكتب سكربت بايثون يحسب مشتقة sin(x)*x^2</span>
      <span class="chip">احسب هبوط الجهد لكابل 150م 100A ثلاثي الأوجه 400V</span>
      <span class="chip">ما الفرق بين TCP و UDP؟</span>
    </div>

    <div id="out" class="card">
      <div class="muted">النتائج ستظهر هنا…</div>
    </div>

    <div class="flex">
      <button class="btn" style="background:#2a3b8f" onclick="copyLast()">نسخ النتيجة</button>
      <button class="btn" style="background:#1f7a4f" onclick="sendFeedback(true)">👍 مفيد</button>
      <button class="btn" style="background:#8f2a2a" onclick="sendFeedback(false)">👎 غير دقيق</button>
      <span class="muted" id="fbMsg"></span>
    </div>

    <div class="footer">
      روابط سريعة:
      <a href="/healthz" target="_blank">healthz</a> •
      <a href="https://github.com" target="_blank">GitHub</a>
    </div>
  </div>

<script>
  const qEl = document.getElementById('q');
  const out = document.getElementById('out');
  const sendBtn = document.getElementById('send');
  const ex = document.getElementById('examples');
  let lastQ = "", lastAnswerText = "", lastTags = [];

  ex.addEventListener('click', (e)=>{
    if(e.target.classList.contains('chip')){
      qEl.value = e.target.textContent.trim();
      ask();
    }
  });

  qEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ ask(); }
  });

  function renderWeb(results){
    if(!results || !results.length) return "<div class='muted'>لا نتائج من الويب.</div>";
    return `<div class="grid">` + results.map(r=>`
      <div class="linkCard">
        <div><b>${escapeHtml(r.title||'بدون عنوان')}</b></div>
        <div><a href="${r.link}" target="_blank">${r.link}</a></div>
        <div class="muted">${escapeHtml(r.summary||r.snippet||'')}</div>
      </div>`).join('') + `</div>`;
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  }

  async function ask(){
    const q = qEl.value.trim();
    if(!q){ out.innerHTML = "<div class='muted'>رجاءً اكتب سؤالك.</div>"; return; }
    lastQ = q; lastAnswerText = ""; lastTags = [];
    sendBtn.disabled = true; out.innerHTML = "<div class='muted'>⏳ جاري المعالجة…</div>";
    try{
      const res = await fetch('/ask?q=' + encodeURIComponent(q));
      if(!res.ok){ out.innerHTML = "<div class='muted'>حدث خطأ في الخادم.</div>"; sendBtn.disabled=false; return; }
      const j = await res.json();

      if(j.type === 'math'){
        lastAnswerText = JSON.stringify(j.result,null,2);
        lastTags = ['math'];
        out.innerHTML = `
          <div class="row"><div class="badge">رياضيات</div></div>
          <pre>${escapeHtml(lastAnswerText)}</pre>`;
      }
      else if(j.type === 'rag'){
        lastAnswerText = (j.summary||'') + "\n\n" + JSON.stringify(j.hits,null,2);
        lastTags = ['rag','local'];
        out.innerHTML = `
          <div class="row"><div class="badge">من ملفاتك (RAG)</div></div>
          ${j.summary ? `<div class="card">${escapeHtml(j.summary)}</div>` : ''}
          <pre>${escapeHtml(JSON.stringify(j.hits,null,2))}</pre>`;
      }
      else if(j.type === 'web'){
        lastAnswerText = (j.results||[]).map(x=>`${x.title}\n${x.link}\n${x.summary||x.snippet||''}`).join("\n\n");
        lastTags = ['web','search'];
        out.innerHTML = `
          <div class="row"><div class="badge">بحث ويب</div></div>
          ${renderWeb(j.results)}`;
      }
      else if(j.msg){
        lastAnswerText = j.msg;
        out.innerHTML = `<div class="card">${escapeHtml(j.msg)}</div>`;
      } else {
        lastAnswerText = JSON.stringify(j,null,2);
        out.innerHTML = `<pre>${escapeHtml(lastAnswerText)}</pre>`;
      }
    }catch(e){
      out.innerHTML = "<div class='muted'>تعذر الاتصال بالخادم.</div>";
    }finally{
      sendBtn.disabled = false;
    }
  }

  function copyLast(){
    if(!lastAnswerText){ return; }
    navigator.clipboard.writeText(lastAnswerText).then(()=>{
      flash("تم النسخ ✅");
    });
  }

  async function sendFeedback(isGood){
    if(!lastQ || !lastAnswerText){ flash("لا توجد نتيجة لإرسالها."); return; }
    const payload = {
      question: lastQ,
      answer: lastAnswerText,
      tags: [...lastTags, isGood ? 'helpful' : 'not_helpful']
    };
    try{
      const r = await fetch('/feedback', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(j.ok){ flash("وصلت ملاحظتك، شكرًا ❤️"); }
      else { flash("تعذر إرسال الملاحظة."); }
    }catch(e){ flash("تعذر إرسال الملاحظة."); }
  }

  function flash(msg){
    const el = document.getElementById('fbMsg');
    el.textContent = msg;
    setTimeout(()=>{ el.textContent = ""; }, 3000);
  }
</script>
</body>
</html>
