<!doctype html>
<meta charset="utf-8" />
<title>Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ â€” Ù…Ø­Ø§Ø¯Ø«Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b1020;--card:#121933;--muted:#8fa3ff;--text:#e9edff;--accent:#3a6dff;--border:#223066}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,Segoe UI,Arial}
  .wrap{max-width:900px;margin:auto;padding:16px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin:8px 0 16px}
  header h1{font-size:20px;margin:0} header .badge{font-size:12px;opacity:.7}
  .examples{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
  .ex{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  .chat{display:flex;flex-direction:column;gap:10px;margin-bottom:130px}
  .msg{display:flex;gap:10px;align-items:flex-start}
  .msg .bubble{padding:12px 14px;border-radius:14px;max-width:85%;white-space:pre-wrap;word-wrap:break-word;border:1px solid var(--border)}
  .me .bubble{background:#123455}
  .bot .bubble{background:var(--card)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .inputbar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#0b1020cc,#0b1020);padding:12px;border-top:1px solid var(--border)}
  .ibox{max-width:900px;margin:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  textarea{flex:1;min-height:48px;max-height:180px;resize:vertical;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px}
  button{background:var(--accent);border:0;color:#fff;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
  .tiny{font-size:12px;opacity:.7}
  .code{background:#0f162f;border:1px solid #23325b;border-radius:10px;padding:10px;overflow:auto}
  input[type=file]{display:none}
  .uploader{background:#0f1a38;border:1px dashed var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
  a{color:#aecdff}
  .pwd{background:#0f1a38;border:1px solid var(--border);color:#e7ecff;border-radius:10px;padding:8px 10px;width:160px}
  .mode{font-size:12px;opacity:.8}
</style>

<div class="wrap">
  <header>
    <h1>ğŸ¤– Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ</h1>
    <span class="badge">v4.1 â€¢ RAG + Math + Web + Upload + Social</span>
    <span class="tiny" id="stats"></span>
    <span class="mode" id="modeLabel"></span>
  </header>

  <div class="examples">
    <div class="ex" onclick="quick('Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´ØªÙ‚Ø© Ù„Ù€ sin(x)^2 + 3x')">ğŸ”¢ Ù…Ø´ØªÙ‚Ø©</div>
    <div class="ex" onclick="quick('Ø¹Ø§ØµÙ…Ø© Ø§Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§')">ğŸŒ Ø¹Ø§ØµÙ…Ø©</div>
    <div class="ex" onclick="quick('ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®Ø±Ø³Ø§Ù†Ø©')">ğŸ“˜ ØªØ¹Ø±ÙŠÙ</div>
    <div class="ex" onclick="quick('Ø§Ø¨Ø­Ø« ÙÙŠ Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù† Ø¹Ù† Mohamed Ali structural engineer')">ğŸ’¼ Ù„ÙŠÙ†ÙƒØ¯Ø¥Ù†</div>
    <div class="ex" onclick="quick('Ø§Ø¨Ø­Ø« Ø­ÙƒÙˆÙ…ÙŠ Ø¹Ù† Ø±Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©')">ğŸ›ï¸ Ø­ÙƒÙˆÙ…ÙŠ</div>
    <div class="ex" onclick="quick('Ø­Ø³Ø§Ø¨ Mohammed Ali username')">ğŸ” Ø¨Ø­Ø« Ø­Ø³Ø§Ø¨</div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="tiny">
    Ø§Ù„ØµØ­Ø©: <a href="/healthz" target="_blank">/healthz</a> â€¢ ÙÙ‡Ø±Ø³Ø©: <code>POST /train</code> â€¢ Ù…Ù„ÙØ§ØªÙƒ: <a href="/list-files" target="_blank">/list-files</a>
  </div>
</div>

<div class="inputbar">
  <div class="ibox">
    <label class="uploader" for="u">ğŸ“„ Ø±ÙØ¹ PDF/MD/TXT</label>
    <input id="u" type="file" accept=".pdf,.md,.txt" />
    <input id="pwd" class="pwd" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±Ù‘ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ³Ù‘Ø¹" />
    <textarea id="q" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒâ€¦ (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
    <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
  const chatEl = document.getElementById('chat');
  const qEl = document.getElementById('q');
  const upEl = document.getElementById('u');
  const pwdEl = document.getElementById('pwd');
  const modeLabel = document.getElementById('modeLabel');

  (async () => {
    try{
      const h = await fetch('/healthz').then(r=>r.json());
      document.getElementById('stats').textContent = `docs: ${h.docs_indexed}`;
    }catch(_){}
  })();

  function quick(text){ qEl.value = text; send(); }

  function addMsg(role, html) {
    const item = document.createElement('div');
    item.className = 'msg ' + (role==='user'?'me':'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = html;
    item.appendChild(bubble);
    chatEl.appendChild(item);
    window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    return bubble;
  }

  function render(j){
    if(j.type==='math'){
      return `<b>Ù†ØªÙŠØ¬Ø© Ø±ÙŠØ§Ø¶ÙŠØ©</b><div class="code">${escapeHtml(JSON.stringify(j.result,null,2))}</div>`;
    }
    if(j.type==='rag'){
      return `<b>Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ</b><div>${escapeHtml(j.summary||'')}</div><div class="code">${escapeHtml(JSON.stringify(j.hits,null,2))}</div>`;
    }
    if(j.type==='web' || j.type==='search'){
      const dom = (j.domains && j.domains.length) ? ` <small>(Ù…ÙÙ„ØªØ±: ${j.domains.join(', ')})</small>` : '';
      return `<b>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«${dom}</b>` + (j.results||[]).map(r=>`
        <div class="bubble" style="background:#0f162f;border:1px solid #23325b;margin-top:6px">
          <b>${escapeHtml(r.title||'Ù†ØªÙŠØ¬Ø©')}</b><br>
          <a href="${r.link}" target="_blank">${r.link}</a>
          <div class="meta">${escapeHtml(r.summary||r.snippet||'')}</div>
        </div>`).join('');
    }
    if(j.type==='definition'){
      return `<b>ğŸ“˜ ØªØ¹Ø±ÙŠÙ</b><div>${escapeHtml(j.answer||j.summary||'')}</div>
              ${j.source?`<div class="meta"><a href="${j.source}" target="_blank">Ø§Ù„Ù…ØµØ¯Ø±: ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§</a></div>`:''}`;
    }
    if(j.type==='fact' && j.kind==='capital'){
      return `<b>Ø­Ù‚ÙŠÙ‚Ø© Ø³Ø±ÙŠØ¹Ø©</b><div>${escapeHtml(j.answer)}</div>
              ${j.source?`<div class="meta"><a href="${j.source}" target="_blank">Ø§Ù„Ù…ØµØ¯Ø±</a></div>`:''}`;
    }
    return escapeHtml(j.answer || j.msg || JSON.stringify(j,null,2));
  }

  async function send(){
    const text = qEl.value.trim();
    const pwd = (pwdEl.value||"").trim();
    if(!text) return;
    qEl.value = '';
    addMsg('user', escapeHtml(text));
    const thinking = addMsg('assistant','â€¦Ø¬Ø§Ø±Ù Ø§Ù„ØªÙÙƒÙŠØ±');
    modeLabel.textContent = pwd ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ³Ù‘Ø¹ Ù…ÙÙØ¹Ù‘Ù„' : '';

    try{
      const url = '/ask?q=' + encodeURIComponent(text) + '&mood=fun' + (pwd?('&pwd='+encodeURIComponent(pwd)):'');
      const res = await fetch(url);
      const j = await res.json();
      thinking.innerHTML = render(j);
    }catch(e){
      thinking.innerHTML = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
    }
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  qEl.addEventListener('keydown', e=>{
    if(e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); send(); }
  });

  upEl.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const form = new FormData();
    form.append('file', f);
    const ph = addMsg('assistant', 'â³ Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆÙÙ‡Ø±Ø³ØªÙ‡â€¦');
    try{
      const r = await fetch('/upload', { method:'POST', body: form });
      const j = await r.json();
      ph.innerHTML = 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù âœ… â€” ' + (j.saved ? `<a href="${j.saved}" target="_blank">${j.saved}</a>` : '');
    }catch(err){
      ph.innerHTML = 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.';
    }
    upEl.value = '';
  });
</script>
