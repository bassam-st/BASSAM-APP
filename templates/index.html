<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>بسّام الذكي v3.6</title>
<style>
  :root{
    --bg:#0b1020;--panel:#11162d;--bubble:#141b2e;--bubble-user:#1e2a50;
    --border:#223066;--text:#e7ecff;--accent:#4b6bff;--muted:#9fb3ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui}
  header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;text-align:center}
  header h1{margin:0;font-size:18px;color:var(--muted)}
  header small{opacity:.7}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--bubble);cursor:pointer}
  .tab.active{background:var(--accent);color:white;border-color:transparent}
  .pane{display:none} .pane.active{display:block}
  .chat{display:flex;flex-direction:column;gap:10px;margin-bottom:90px}
  .msg{max-width:85%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--bubble);white-space:pre-wrap;line-height:1.7}
  .user{align-self:flex-start;background:var(--bubble-user)}
  .bot{align-self:flex-end}
  .meta{display:block;font-size:12px;opacity:.6;margin-top:6px}
  .footer{position:fixed;inset-inline:0;bottom:0;background:var(--panel);border-top:1px solid var(--border)}
  .send{max-width:960px;margin:10px auto;display:flex;gap:8px;padding:0 16px}
  input[type=text]{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1a38;color:white}
  button{padding:12px 16px;border:none;border-radius:12px;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  a{color:#8fb1ff} .card{background:#0f1530;border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0}
  .mono{font-family:ui-monospace,Consolas,monospace;font-size:13px}
  .uploader{border:1px dashed var(--border);border-radius:12px;padding:14px;background:#0f1530}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{opacity:.75}
</style>
</head>
<body>
<header>
  <h1>🤖 بسّام الذكي — v3.6</h1>
  <small>دردشة • رفع PDF للفهرسة • بحث عكسي للصور</small>
</header>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-pane="chat">الدردشة</div>
    <div class="tab" data-pane="pdf">رفع PDF</div>
    <div class="tab" data-pane="image">بحث عكسي بصورة</div>
    <div class="tab" onclick="window.open('/files_list','_blank')">📂 ملفاتي</div>
    <div class="tab" onclick="window.open('/healthz','_blank')">الصحة</div>
  </div>

  <!-- دردشة -->
  <div id="pane-chat" class="pane active">
    <div id="chat" class="chat">
      <div class="msg bot">
        أهلًا! أنا بسّام 😊 اكتب سؤالك وسأحاول أولًا من ملفاتك (RAG) ثم الويب ثم الرياضيات.
        <span class="meta">جرّب: <span class="muted">"ما هي الخرسانة المسلحة؟"، "تفاضل x^3"، "ابحث في الويب عن عاصمة ألمانيا"</span></span>
      </div>
    </div>
    <div class="footer">
      <div class="send">
        <input id="q" type="text" placeholder="اكتب سؤالك هنا… ثم اضغط إرسال أو Enter" onkeydown="if(event.key==='Enter'){send()}" />
        <button id="btn" onclick="send()">إرسال</button>
      </div>
    </div>
  </div>

  <!-- رفع PDF -->
  <div id="pane-pdf" class="pane">
    <div class="uploader">
      <div class="row">
        <input id="pdf" type="file" accept="application/pdf" />
        <button onclick="uploadPDF()">رفع و فهرسة</button>
      </div>
      <div id="pdf-result" class="card mono"></div>
      <small class="muted">بعد الرفع أُحوّل الـPDF إلى نص وأضيفه لفهرس RAG تلقائيًا.</small>
    </div>
  </div>

  <!-- بحث عكسي بصورة -->
  <div id="pane-image" class="pane">
    <div class="uploader">
      <div class="row">
        <input id="img" type="file" accept="image/*" />
        <button onclick="uploadImage()">رفع صورة</button>
      </div>
      <div id="img-result" class="card"></div>
      <small class="muted">سأعطيك روابط بحث عكسي جاهزة (Google/Bing/Yandex/TinEye) على الصورة التي رفعتها.</small>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const qbox = document.getElementById('q');
const btn  = document.getElementById('btn');

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.getAttribute('data-pane');
    document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
    if (id) document.getElementById('pane-'+id).classList.add('active');
  });
});

function add(text, who='bot', isHTML=false){
  const div=document.createElement('div');
  div.className='msg '+(who==='user'?'user':'bot');
  div[isHTML?'innerHTML':'textContent']=text;
  chat.appendChild(div);
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  return div;
}

function showWeb(results){
  if(!results||!results.length) return 'لم أجد نتائج من الويب.';
  return results.map(r=>`
    <div class="card">
      <b>${r.title||''}</b><br>
      <a href="${r.link}" target="_blank">${r.link}</a>
      <div>${r.summary||r.snippet||''}</div>
    </div>`).join('');
}

async function send(){
  const q=(qbox.value||'').trim();
  if(!q) return;
  add(q,'user'); qbox.value=''; qbox.focus();
  const wait=add('⏳ جاري المعالجة…','bot');

  btn.disabled=true;
  try{
    const res=await fetch('/ask?q='+encodeURIComponent(q));
    const j=await res.json();
    wait.remove();

    if(j.type==='rag'){
      add('<b>📚 من ملفاتك (RAG):</b><div class="mono">'+(j.summary||'')+'</div>','bot',true);
    }else if(j.type==='web'){
      add('<b>🌐 من الويب:</b>'+showWeb(j.results),'bot',true);
    }else if(j.type==='math'){
      add('<b>🧮 رياضيات:</b><pre class="mono">'+JSON.stringify(j.result,null,2)+'</pre>','bot',true);
    }else if(j.msg){
      add(j.msg,'bot');
    }else{
      add('<pre class="mono">'+JSON.stringify(j,null,2)+'</pre>','bot',true);
    }
  }catch(e){
    wait.remove();
    add('⚠️ حدث خطأ بالاتصال بالخادم.','bot');
  }finally{
    btn.disabled=false;
  }
}

async function uploadPDF(){
  const inp=document.getElementById('pdf');
  const box=document.getElementById('pdf-result');
  if(!inp.files.length){ box.textContent='اختر ملف PDF أولًا.'; return; }
  const fd=new FormData(); fd.append('file', inp.files[0]);
  box.textContent='⏳ جاري الرفع والفهرسة...';
  try{
    const res=await fetch('/upload/pdf',{method:'POST',body:fd});
    const j=await res.json();
    box.innerHTML='<b>تم الرفع ✔️</b><br>الرابط: <a target="_blank" href="'+j.file_url+'">'+j.file_url+'</a><br>عدد المستندات في الفهرس: '+j.indexed_docs;
  }catch(e){
    box.textContent='فشل الرفع.';
  }
}

async function uploadImage(){
  const inp=document.getElementById('img');
  const box=document.getElementById('img-result');
  if(!inp.files.length){ box.textContent='اختر صورة أولًا.'; return; }
  const fd=new FormData(); fd.append('file', inp.files[0]);
  box.textContent='⏳ جاري الرفع...';
  try{
    const res=await fetch('/upload/image',{method:'POST',body:fd});
    const j=await res.json();
    box.innerHTML = `
      <div>تم الرفع ✔️ — <a target="_blank" href="${j.image_url}">فتح الصورة</a></div>
      <div class="card">
        <div><a target="_blank" href="${j.reverse.google}">بحث Google</a></div>
        <div><a target="_blank" href="${j.reverse.bing}">بحث Bing</a></div>
        <div><a target="_blank" href="${j.reverse.yandex}">بحث Yandex</a></div>
        <div><a target="_blank" href="${j.reverse.tineye}">بحث TinEye</a></div>
      </div>`;
  }catch(e){
    box.textContent='فشل الرفع.';
  }
}
</script>
</body>
</html>
